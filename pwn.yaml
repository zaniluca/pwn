vmType: "qemu"
arch: "x86_64"

images:
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img"
    arch: "x86_64"

cpus: 4
memory: "8GiB"
disk: "50GiB"

mounts:
  - location: "~"
    writable: true
  - location: "/tmp/lima"
    writable: true

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux
      apt-get update
      apt-get install -y \
        build-essential \
        gdb \
        gdbserver \
        gfortran \
        git \
        tmux \
        python3 \
        python3-pip \
        python3-dev \
        python3-full \
        curl \
        wget \
        file \
        netcat-openbsd \
        socat \
        ltrace \
        strace \
        debuginfod \
        patchelf \
        ruby \
        ruby-dev \
        qemu-system \
        ncat

      # Install one_gadget (Ruby gem)
      gem install one_gadget

  - mode: user
    script: |
      #!/bin/bash
      set -eux

      # Install pwndbg
      cd ~
      git clone --depth 1 https://github.com/pwndbg/pwndbg
      cd pwndbg
      ./setup.sh

      # Install required python packages
      python3 -m pip install --upgrade pwntools ropper angr libdebug --break-system-packages

      # Set tmux as default terminal for pwntools
      echo "" >> ~/.bashrc
      echo "# Pwntools terminal config" >> ~/.bashrc
      echo "export PWNTOOLS_TERMINAL='tmux splitw -h'" >> ~/.bashrc

      # Enable mouse support in tmux
      echo "set -g mouse on" >> ~/.tmux.conf

      # Configure debuginfod to retrive debug symbols
      echo "" >> ~/.bashrc
      echo "# Debuginfod configuration" >> ~/.bashrc
      echo "export DEBUGINFOD_URLS=\"https://debuginfod.elfutils.org/\"" >> ~/.bashrc

      # Add Ruby gem user bin to PATH
      echo "" >> ~/.bashrc
      echo "# Ruby gems PATH" >> ~/.bashrc
      echo "export PATH=\"\$HOME/.local/share/gem/ruby/3.3.0/bin:\$PATH\"" >> ~/.bashrc

  - mode: system
    script: |
      #!/bin/bash
      set -eux

      # Symlink pwndbg configuration to root's home so sudo gdb uses pwndbg
      LIMA_USER=$(ls /home | head -n 1)
      if [ -f "/home/$LIMA_USER/.gdbinit" ]; then
        ln -sf "/home/$LIMA_USER/.gdbinit" /root/.gdbinit
        echo "Symlinked pwndbg configuration to root"
      fi

message: |
  Environment setup is complete!
  Your Mac home directory is writable at: /Users/<username>/
